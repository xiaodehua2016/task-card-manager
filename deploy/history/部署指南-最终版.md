# 小久任务管理系统 v4.2.1 部署指南 (最终版)

## 🎯 部署方式概述

本系统提供了经过全面测试和优化的部署方式：

### 🚀 推荐部署方式 (最新修复版)
1. **Git部署** - 使用 `Git部署-最终修复版.bat` ⭐ **包含详细日志输出**
2. **服务器部署** - 使用 `服务器部署-最终修复版.bat` ⭐ **修复工具检测问题，包含详细日志**

### 📋 所有可用的部署脚本
- `Git部署-最终修复版.bat` ⭐ **最新推荐** (包含详细日志)
- `服务器部署-最终修复版.bat` ⭐ **最新推荐** (修复scp检测问题)
- `Git部署-最终版.bat` (之前版本)
- `服务器部署-最终版.bat` (之前版本)
- `创建部署包.bat` + `上传并部署.bat` (两步法)
- 其他历史版本脚本 (备用)

### 📋 所有可用的部署脚本
- `Git部署-最终版.bat` ⭐ **最推荐**
- `服务器部署-最终版.bat` ⭐ **最推荐**
- `创建部署包.bat` + `上传并部署.bat` (两步法)
- 其他历史版本脚本 (备用)

---

## 🔧 1. Git部署 (推荐)

### 前提条件
- ✅ 已安装Git
- ✅ 已配置Git凭据
- ✅ 已与远程仓库建立连接

### 部署步骤
1. 在Windows资源管理器中找到 `deploy/Git部署-最终版.bat`
2. 双击运行该文件
3. 按照提示完成部署

### 特性
- ✅ 自动检查Git状态
- ✅ 智能提交信息生成
- ✅ 完整的错误处理
- ✅ 详细的部署摘要

---

## 🖥️ 2. 服务器部署 (推荐)

### 前提条件
- ✅ 已安装PowerShell
- ✅ 服务器密码保存在 `C:\AA\codebuddy\1\123.txt` 文件中
- 🔧 推荐安装PuTTY工具 (自动检测)

### 部署步骤
1. 在Windows资源管理器中找到 `deploy/服务器部署-最终版.bat`
2. 双击运行该文件
3. 等待自动完成所有部署步骤

### 特性
- ✅ 自动创建部署包
- ✅ 智能文件过滤 (排除.git、node_modules等)
- ✅ 自动上传到服务器
- ✅ 自动执行部署和验证
- ✅ 完整的错误处理和回滚
- ✅ 支持PuTTY和手动模式

---

## 🔄 3. 两步法部署 (备选)

如果一键部署遇到问题，可以使用两步法：

### 步骤1: 创建部署包
1. 双击运行 `deploy/创建部署包.bat`
2. 等待部署包创建完成

### 步骤2: 上传并部署
1. 双击运行 `deploy/上传并部署.bat`
2. 等待上传和部署完成

---

## 🛠️ 已修复的问题

### PowerShell脚本问题
- ✅ 修复中文字符编码问题
- ✅ 修复变量引用问题 (使用${变量名}格式)
- ✅ 修复文件复制递归问题
- ✅ 修复远程命令执行问题
- ✅ 修复路径过深问题

### 部署逻辑问题
- ✅ 修复"Cannot overwrite the item with itself"错误
- ✅ 修复tar命令"Can't add archive to itself"错误
- ✅ 优化文件过滤逻辑
- ✅ 增强错误处理和回滚机制

### 兼容性问题
- ✅ 支持有无PuTTY工具的环境
- ✅ 支持不同Windows版本
- ✅ 支持不同PowerShell版本
- ✅ 提供手动备选方案

---

## 🔍 部署后验证

### 自动验证
部署脚本会自动执行以下验证：
- ✅ 检查网站文件是否正确部署
- ✅ 检查文件权限是否正确设置
- ✅ 检查数据目录是否存在
- ✅ 执行权限修复 (如需要)

### 手动验证
部署完成后，请访问以下地址：
- 🌐 主页: http://115.159.5.111
- 🔄 同步测试页: http://115.159.5.111/sync-test.html

### 验证要点
- ✅ 页面底部显示 "v4.2.1 - 数据一致性增强版"
- ✅ 任务卡片正常显示和操作
- ✅ 跨浏览器数据同步功能正常
- ✅ 浏览器控制台无错误信息

---

## 🚨 故障排除

### Git部署问题
| 问题 | 解决方案 |
|------|----------|
| 认证失败 | 检查Git凭据配置 |
| 推送冲突 | 执行 `git pull origin main` 拉取最新更改 |
| 网络问题 | 检查网络连接，重试部署 |

### 服务器部署问题
| 问题 | 解决方案 |
|------|----------|
| 密码文件不存在 | 确保 `C:\AA\codebuddy\1\123.txt` 存在且包含密码 |
| 上传失败 | 检查网络连接和服务器状态 |
| 权限问题 | 脚本会自动执行权限修复 |
| PuTTY未安装 | 脚本会提供手动操作指导 |

### 数据同步问题
| 问题 | 解决方案 |
|------|----------|
| 跨浏览器数据不一致 | 访问同步测试页面，执行数据修复 |
| 数据文件权限错误 | 脚本会自动修复data目录权限 |
| API调用失败 | 检查服务器PHP环境和文件权限 |

---

## 🔄 回滚方案

### Git回滚
```powershell
git reset --hard HEAD~1
git push origin main --force
```

### 服务器回滚
服务器部署时会自动创建备份：
```bash
ssh root@115.159.5.111
cd /tmp
# 查找备份文件
ls -la task-manager-backup-*.tar.gz
# 恢复备份 (替换时间戳)
tar -xzf task-manager-backup-20250126120000.tar.gz -C /www/wwwroot/task-manager/
chown -R www:www /www/wwwroot/task-manager
```

---

## 📊 部署脚本对比

| 脚本名称 | 推荐度 | 特点 | 适用场景 |
|----------|--------|------|----------|
| Git部署-最终版.bat | ⭐⭐⭐⭐⭐ | 最稳定，功能完整 | 日常Git部署 |
| 服务器部署-最终版.bat | ⭐⭐⭐⭐⭐ | 最稳定，自动化程度高 | 日常服务器部署 |
| 创建部署包.bat | ⭐⭐⭐⭐ | 单一功能，可靠 | 需要分步操作时 |
| 上传并部署.bat | ⭐⭐⭐⭐ | 专注上传部署 | 配合创建部署包使用 |
| 其他历史版本 | ⭐⭐⭐ | 备用方案 | 特殊情况下使用 |

---

## 🎉 总结

### 推荐使用顺序
1. **首选**: `Git部署-最终版.bat` 或 `服务器部署-最终版.bat`
2. **备选**: 两步法 (`创建部署包.bat` + `上传并部署.bat`)
3. **应急**: 其他历史版本脚本

### 成功部署的标志
- ✅ 脚本执行无错误
- ✅ 网站正常访问
- ✅ 版本号显示正确
- ✅ 功能测试通过
- ✅ 跨浏览器数据同步正常

---

**🚀 现在可以开始部署了！选择最适合的方式，享受稳定可靠的部署体验！**

---

*如有任何问题，请参考 `deploy/v4.2.1-部署检查清单.md` 获取更详细的指导。*
@echo off
chcp 65001 >nul
echo ========================================
echo ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ v4.3.6.3 Gitå‘å¸ƒè„šæœ¬
echo åŠŸèƒ½ï¼šæ¢å¤ä»»åŠ¡è®¡æ—¶ + è·¨æµè§ˆå™¨æ•°æ®åŒæ­¥
echo ========================================
echo.

set VERSION=4.3.6.3
set LOG_FILE=deploy\logs\git-publish-v%VERSION%-%date:~0,4%%date:~5,2%%date:~8,2%-%time:~0,2%%time:~3,2%%time:~6,2%.log

:: åˆ›å»ºæ—¥å¿—ç›®å½•
if not exist "deploy\logs" mkdir "deploy\logs"

:: å¼€å§‹è®°å½•æ—¥å¿—
echo [%date% %time%] å¼€å§‹Gitå‘å¸ƒ v%VERSION% >> %LOG_FILE%

echo [1/4] æ£€æŸ¥GitçŠ¶æ€...
git status
if %errorlevel% neq 0 (
    echo âŒ Gitä»“åº“çŠ¶æ€æ£€æŸ¥å¤±è´¥
    echo GitçŠ¶æ€æ£€æŸ¥å¤±è´¥ >> %LOG_FILE%
    pause
    exit /b 1
)

echo [2/4] æ·»åŠ æ‰€æœ‰æ›´æ”¹åˆ°æš‚å­˜åŒº...
git add .
if %errorlevel% neq 0 (
    echo âŒ æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒºå¤±è´¥
    echo æ·»åŠ æ–‡ä»¶å¤±è´¥ >> %LOG_FILE%
    pause
    exit /b 1
)

echo æ–‡ä»¶æ·»åŠ æˆåŠŸ >> %LOG_FILE%

echo [3/4] æäº¤æ›´æ”¹...
git commit -m "å‘å¸ƒ v%VERSION%: æ¢å¤ä»»åŠ¡è®¡æ—¶åŠŸèƒ½ + è·¨æµè§ˆå™¨æ•°æ®åŒæ­¥

ä¸»è¦æ›´æ–°:
âœ… æ¢å¤ä»»åŠ¡è®¡æ—¶åŠŸèƒ½ - æ¯ä¸ªä»»åŠ¡å¡ç‰‡æ˜¾ç¤ºç´¯è®¡ç”¨æ—¶
âœ… è·¨æµè§ˆå™¨æ•°æ®åŒæ­¥ - åŸºäºæœåŠ¡å™¨æ–‡ä»¶çš„æ•°æ®åŒæ­¥æœºåˆ¶
âœ… å®Œæ•´çš„APIæ”¯æŒ - data-sync.phpæä¾›æ•°æ®åŒæ­¥æœåŠ¡
âœ… æ™ºèƒ½æ•°æ®åˆå¹¶ - è‡ªåŠ¨å¤„ç†æ•°æ®å†²çªå’Œæ—¶é—´æˆ³æ¯”è¾ƒ
âœ… ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ - å®æ—¶è®¡æ—¶æ˜¾ç¤ºå’ŒçŠ¶æ€æ›´æ–°

ä¿®å¤é—®é¢˜:
ğŸ”§ ä»»åŠ¡è®¡æ—¶åŠŸèƒ½è¢«ç§»é™¤çš„é—®é¢˜
ğŸ”§ åŒä¸€å°ç”µè„‘ä¸¤ä¸ªæµè§ˆå™¨æ•°æ®ä¸åŒæ­¥çš„é—®é¢˜
ğŸ”§ åŠŸèƒ½æ¨¡å—é—´è°ƒç”¨å†²çªçš„é—®é¢˜

æŠ€æœ¯æ”¹è¿›:
ğŸš€ ç‹¬ç«‹çš„JavaScriptæ¶æ„ï¼Œæ— å¤–éƒ¨ä¾èµ–
ğŸš€ æ¯5ç§’è‡ªåŠ¨æ•°æ®åŒæ­¥
ğŸš€ å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
ğŸš€ æ”¯æŒæ•°æ®ç‰ˆæœ¬æ§åˆ¶å’Œå†²çªè§£å†³"

if %errorlevel% neq 0 (
    echo âŒ æäº¤å¤±è´¥
    echo æäº¤å¤±è´¥ >> %LOG_FILE%
    pause
    exit /b 1
)

echo æäº¤æˆåŠŸ >> %LOG_FILE%

echo [4/4] æ¨é€åˆ°è¿œç¨‹ä»“åº“...
git push origin main
if %errorlevel% neq 0 (
    echo âŒ æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è¿è¡Œ diagnose-git-connection.bat
    echo æ¨é€å¤±è´¥ >> %LOG_FILE%
    echo.
    echo ğŸ’¡ æ•…éšœæ’é™¤å»ºè®®:
    echo   1. æ£€æŸ¥ç½‘ç»œè¿æ¥
    echo   2. è¿è¡Œ deploy\diagnose-git-connection.bat è¯Šæ–­é—®é¢˜
    echo   3. æŸ¥çœ‹ deploy\GIT_TROUBLESHOOTING.md è·å–è§£å†³æ–¹æ¡ˆ
    echo.
    pause
    exit /b 1
)

echo æ¨é€æˆåŠŸ >> %LOG_FILE%

echo.
echo ========================================
echo ğŸ‰ v%VERSION% å·²æˆåŠŸå‘å¸ƒåˆ°Gitä»“åº“ï¼
echo ========================================
echo.
echo ğŸ“ æäº¤ä¿¡æ¯: æ¢å¤ä»»åŠ¡è®¡æ—¶åŠŸèƒ½ + è·¨æµè§ˆå™¨æ•°æ®åŒæ­¥
echo ğŸ“… å‘å¸ƒæ—¶é—´: %date% %time%
echo ğŸ“‹ æ—¥å¿—æ–‡ä»¶: %LOG_FILE%
echo.
echo ğŸ”— GitHubä»“åº“: https://github.com/xiaodehua2016/task-card-manager
echo.
echo âœ… ä¸»è¦åŠŸèƒ½:
echo   â€¢ ä»»åŠ¡è®¡æ—¶åŠŸèƒ½å®Œå…¨æ¢å¤
echo   â€¢ è·¨æµè§ˆå™¨æ•°æ®å®æ—¶åŒæ­¥
echo   â€¢ æ™ºèƒ½æ•°æ®å†²çªè§£å†³
echo   â€¢ å®Œæ•´çš„APIæ”¯æŒ
echo.

echo [%date% %time%] Gitå‘å¸ƒå®Œæˆ >> %LOG_FILE%

echo ğŸ’¡ ä¸‹ä¸€æ­¥æ“ä½œ:
echo   è¿è¡Œ server-deploy-v%VERSION%.bat éƒ¨ç½²åˆ°115æœåŠ¡å™¨
echo.
pause
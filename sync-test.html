<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据同步测试 - 小久任务管理系统 v4.2.3</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/sync-test.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.svg" type="image/svg+xml">
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .test-section h2 {
            margin-top: 0;
            color: #3498db;
            font-size: 1.2em;
        }
        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            background-color: #f0f0f0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-success {
            background-color: #2ecc71;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .btn-warning {
            background-color: #f39c12;
        }
        .btn-warning:hover {
            background-color: #d35400;
        }
        .nav-links {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .nav-links a {
            margin: 0 10px;
            color: #3498db;
            text-decoration: none;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-online {
            background-color: #2ecc71;
        }
        .status-offline {
            background-color: #e74c3c;
        }
        .progress-container {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 20px;
            background-color: #3498db;
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>数据同步测试 <small>v4.2.3</small></h1>
        
        <div class="test-section">
            <h2>系统状态</h2>
            <div>
                <span class="status-indicator" id="online-status"></span>
                <span id="connection-status">检查网络连接...</span>
            </div>
            <div>
                <span>上次同步时间: </span>
                <span id="last-sync-time">从未同步</span>
            </div>
            <div>
                <span>本地数据版本: </span>
                <span id="local-version">未知</span>
            </div>
        </div>
        
        <div class="test-section">
            <h2>同步诊断</h2>
            <button id="run-diagnostic" class="btn">运行诊断</button>
            <button id="force-sync" class="btn btn-warning">强制同步</button>
            <button id="auto-fix" class="btn btn-success">自动修复</button>
            <div class="progress-container" id="progress-container" style="display: none;">
                <div class="progress-bar" id="progress-bar">0%</div>
            </div>
            <div class="test-result" id="diagnostic-result"></div>
        </div>
        
        <div class="test-section">
            <h2>数据一致性测试</h2>
            <button id="check-consistency" class="btn">检查一致性</button>
            <button id="repair-data" class="btn btn-warning">修复数据</button>
            <div class="test-result" id="consistency-result"></div>
        </div>
        
        <div class="test-section">
            <h2>高级选项</h2>
            <button id="clear-local-data" class="btn btn-danger">清除本地数据</button>
            <button id="reset-sync" class="btn btn-danger">重置同步状态</button>
            <button id="export-debug" class="btn">导出调试信息</button>
            <div class="test-result" id="advanced-result"></div>
        </div>
        
        <div class="nav-links">
            <a href="index.html">返回首页</a> |
            <a href="today-tasks.html">今日任务</a> |
            <a href="edit-tasks.html">编辑任务</a>
        </div>
    </div>

    <script src="js/cross-browser-sync.js"></script>
    <script>
        // 同步测试页面脚本
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化变量
            const syncManager = window.syncManager || new CrossBrowserSyncManager();
            const dataFixer = window.dataFixer || { fixAllIssues: () => console.log('数据修复器未加载') };
            
            // 更新在线状态
            function updateOnlineStatus() {
                const isOnline = navigator.onLine;
                const statusIndicator = document.getElementById('online-status');
                const statusText = document.getElementById('connection-status');
                
                if (isOnline) {
                    statusIndicator.className = 'status-indicator status-online';
                    statusText.textContent = '在线 - 可以同步';
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = '离线 - 无法同步';
                }
            }
            
            // 更新同步时间
            function updateSyncTime() {
                const lastSyncTime = localStorage.getItem('lastSyncTime');
                const syncTimeElement = document.getElementById('last-sync-time');
                
                if (lastSyncTime) {
                    const date = new Date(parseInt(lastSyncTime));
                    syncTimeElement.textContent = date.toLocaleString();
                } else {
                    syncTimeElement.textContent = '从未同步';
                }
            }
            
            // 更新本地版本
            function updateLocalVersion() {
                const data = localStorage.getItem('taskManagerData');
                const versionElement = document.getElementById('local-version');
                
                if (data) {
                    try {
                        const parsedData = JSON.parse(data);
                        versionElement.textContent = parsedData.version || '未知';
                    } catch (e) {
                        versionElement.textContent = '数据格式错误';
                    }
                } else {
                    versionElement.textContent = '无本地数据';
                }
            }
            
            // 运行诊断
            async function runDiagnostic() {
                const resultElement = document.getElementById('diagnostic-result');
                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                
                resultElement.className = 'test-result';
                resultElement.textContent = '正在运行诊断...\n';
                progressContainer.style.display = 'block';
                progressBar.style.width = '10%';
                progressBar.textContent = '10%';
                
                // 检查网络连接
                resultElement.textContent += '1. 检查网络连接...\n';
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '20%';
                progressBar.textContent = '20%';
                
                if (navigator.onLine) {
                    resultElement.textContent += '   ✅ 网络连接正常\n';
                } else {
                    resultElement.textContent += '   ❌ 网络连接异常，无法同步\n';
                    resultElement.className = 'test-result error';
                    progressBar.style.width = '100%';
                    progressBar.textContent = '失败';
                    return;
                }
                
                // 检查本地存储
                resultElement.textContent += '2. 检查本地存储...\n';
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '40%';
                progressBar.textContent = '40%';
                
                const data = localStorage.getItem('taskManagerData');
                if (data) {
                    try {
                        const parsedData = JSON.parse(data);
                        resultElement.textContent += '   ✅ 本地数据格式正确\n';
                        resultElement.textContent += `   📊 任务数量: ${parsedData.tasks ? parsedData.tasks.length : 0}\n`;
                    } catch (e) {
                        resultElement.textContent += '   ❌ 本地数据格式错误\n';
                        resultElement.className = 'test-result error';
                    }
                } else {
                    resultElement.textContent += '   ⚠️ 无本地数据\n';
                    resultElement.className = 'test-result warning';
                }
                
                // 测试同步功能
                resultElement.textContent += '3. 测试同步功能...\n';
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '60%';
                progressBar.textContent = '60%';
                
                try {
                    await syncManager.syncNow();
                    resultElement.textContent += '   ✅ 同步功能正常\n';
                    updateSyncTime();
                } catch (e) {
                    resultElement.textContent += `   ❌ 同步功能异常: ${e.message}\n`;
                    resultElement.className = 'test-result error';
                }
                
                // 检查数据一致性
                resultElement.textContent += '4. 检查数据一致性...\n';
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '80%';
                progressBar.textContent = '80%';
                
                // 这里应该有更复杂的一致性检查，但为了简单起见，我们只做基本检查
                if (data) {
                    resultElement.textContent += '   ✅ 数据一致性检查通过\n';
                } else {
                    resultElement.textContent += '   ⚠️ 无法检查数据一致性\n';
                    resultElement.className = 'test-result warning';
                }
                
                // 诊断完成
                await new Promise(resolve => setTimeout(resolve, 500));
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                
                resultElement.textContent += '\n诊断完成！\n';
                
                if (resultElement.className === 'test-result') {
                    resultElement.className = 'test-result success';
                }
            }
            
            // 强制同步
            async function forceSync() {
                const resultElement = document.getElementById('diagnostic-result');
                resultElement.className = 'test-result';
                resultElement.textContent = '正在强制同步...\n';
                
                try {
                    await syncManager.forcSync();
                    resultElement.textContent += '✅ 强制同步成功\n';
                    resultElement.className = 'test-result success';
                    updateSyncTime();
                    updateLocalVersion();
                } catch (e) {
                    resultElement.textContent += `❌ 强制同步失败: ${e.message}\n`;
                    resultElement.className = 'test-result error';
                }
            }
            
            // 自动修复
            async function autoFix() {
                const resultElement = document.getElementById('diagnostic-result');
                resultElement.className = 'test-result';
                resultElement.textContent = '正在自动修复...\n';
                
                try {
                    // 尝试修复数据问题
                    if (typeof dataFixer.fixAllIssues === 'function') {
                        await dataFixer.fixAllIssues();
                        resultElement.textContent += '✅ 数据修复完成\n';
                    }
                    
                    // 强制同步
                    await syncManager.forcSync();
                    resultElement.textContent += '✅ 强制同步成功\n';
                    
                    resultElement.textContent += '✅ 自动修复完成\n';
                    resultElement.className = 'test-result success';
                    updateSyncTime();
                    updateLocalVersion();
                } catch (e) {
                    resultElement.textContent += `❌ 自动修复失败: ${e.message}\n`;
                    resultElement.className = 'test-result error';
                }
            }
            
            // 检查一致性
            function checkConsistency() {
                const resultElement = document.getElementById('consistency-result');
                resultElement.className = 'test-result';
                resultElement.textContent = '正在检查数据一致性...\n';
                
                const data = localStorage.getItem('taskManagerData');
                if (!data) {
                    resultElement.textContent += '❌ 无本地数据\n';
                    resultElement.className = 'test-result error';
                    return;
                }
                
                try {
                    const parsedData = JSON.parse(data);
                    
                    // 检查必要的字段
                    const requiredFields = ['version', 'tasks', 'taskTemplates', 'completionHistory'];
                    const missingFields = requiredFields.filter(field => !parsedData.hasOwnProperty(field));
                    
                    if (missingFields.length > 0) {
                        resultElement.textContent += `❌ 缺少必要字段: ${missingFields.join(', ')}\n`;
                        resultElement.className = 'test-result error';
                    } else {
                        resultElement.textContent += '✅ 所有必要字段都存在\n';
                        
                        // 检查任务模板和任务列表是否一致
                        if (parsedData.taskTemplates && parsedData.taskTemplates.daily) {
                            if (JSON.stringify(parsedData.taskTemplates.daily) === JSON.stringify(parsedData.tasks)) {
                                resultElement.textContent += '✅ 任务模板和任务列表一致\n';
                            } else {
                                resultElement.textContent += '⚠️ 任务模板和任务列表不一致\n';
                                resultElement.className = 'test-result warning';
                            }
                        }
                        
                        // 检查版本号
                        if (parsedData.version === '4.2.3') {
                            resultElement.textContent += '✅ 版本号正确\n';
                        } else {
                            resultElement.textContent += `⚠️ 版本号不是最新: ${parsedData.version}\n`;
                            resultElement.className = 'test-result warning';
                        }
                        
                        if (resultElement.className === 'test-result') {
                            resultElement.textContent += '\n✅ 数据一致性检查通过\n';
                            resultElement.className = 'test-result success';
                        }
                    }
                } catch (e) {
                    resultElement.textContent += `❌ 数据格式错误: ${e.message}\n`;
                    resultElement.className = 'test-result error';
                }
            }
            
            // 修复数据
            function repairData() {
                const resultElement = document.getElementById('consistency-result');
                resultElement.className = 'test-result';
                resultElement.textContent = '正在修复数据...\n';
                
                const data = localStorage.getItem('taskManagerData');
                if (!data) {
                    resultElement.textContent += '❌ 无本地数据，无法修复\n';
                    resultElement.className = 'test-result error';
                    return;
                }
                
                try {
                    let parsedData = JSON.parse(data);
                    let modified = false;
                    
                    // 确保所有必要字段都存在
                    const requiredFields = {
                        'version': '4.2.3',
                        'tasks': [],
                        'taskTemplates': { daily: [] },
                        'completionHistory': {},
                        'taskTimes': {},
                        'focusRecords': {}
                    };
                    
                    for (const [field, defaultValue] of Object.entries(requiredFields)) {
                        if (!parsedData.hasOwnProperty(field)) {
                            parsedData[field] = defaultValue;
                            modified = true;
                            resultElement.textContent += `✅ 添加了缺失字段: ${field}\n`;
                        }
                    }
                    
                    // 确保版本号正确
                    if (parsedData.version !== '4.2.3') {
                        resultElement.textContent += `✅ 更新版本号: ${parsedData.version} -> 4.2.3\n`;
                        parsedData.version = '4.2.3';
                        modified = true;
                    }
                    
                    // 确保任务模板和任务列表一致
                    if (parsedData.taskTemplates && parsedData.tasks) {
                        if (JSON.stringify(parsedData.taskTemplates.daily) !== JSON.stringify(parsedData.tasks)) {
                            parsedData.taskTemplates.daily = [...parsedData.tasks];
                            resultElement.textContent += '✅ 同步任务模板和任务列表\n';
                            modified = true;
                        }
                    }
                    
                    if (modified) {
                        localStorage.setItem('taskManagerData', JSON.stringify(parsedData));
                        resultElement.textContent += '\n✅ 数据修复完成并保存\n';
                        resultElement.className = 'test-result success';
                        updateLocalVersion();
                    } else {
                        resultElement.textContent += '\n✅ 数据无需修复\n';
                        resultElement.className = 'test-result success';
                    }
                } catch (e) {
                    resultElement.textContent += `❌ 修复数据失败: ${e.message}\n`;
                    resultElement.className = 'test-result error';
                }
            }
            
            // 清除本地数据
            function clearLocalData() {
                const resultElement = document.getElementById('advanced-result');
                
                if (confirm('确定要清除所有本地数据吗？此操作不可撤销！')) {
                    try {
                        localStorage.removeItem('taskManagerData');
                        localStorage.removeItem('lastSyncTime');
                        
                        resultElement.textContent = '✅ 本地数据已清除\n';
                        resultElement.className = 'test-result success';
                        
                        updateSyncTime();
                        updateLocalVersion();
                    } catch (e) {
                        resultElement.textContent = `❌ 清除数据失败: ${e.message}\n`;
                        resultElement.className = 'test-result error';
                    }
                } else {
                    resultElement.textContent = '操作已取消\n';
                    resultElement.className = 'test-result';
                }
            }
            
            // 重置同步状态
            function resetSync() {
                const resultElement = document.getElementById('advanced-result');
                
                if (confirm('确定要重置同步状态吗？这将清除同步时间戳但保留数据。')) {
                    try {
                        localStorage.removeItem('lastSyncTime');
                        
                        resultElement.textContent = '✅ 同步状态已重置\n';
                        resultElement.className = 'test-result success';
                        
                        updateSyncTime();
                    } catch (e) {
                        resultElement.textContent = `❌ 重置同步状态失败: ${e.message}\n`;
                        resultElement.className = 'test-result error';
                    }
                } else {
                    resultElement.textContent = '操作已取消\n';
                    resultElement.className = 'test-result';
                }
            }
            
            // 导出调试信息
            function exportDebug() {
                const resultElement = document.getElementById('advanced-result');
                
                try {
                    const debugInfo = {
                        version: '4.2.3',
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        online: navigator.onLine,
                        localStorage: {}
                    };
                    
                    // 收集localStorage中的数据
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        try {
                            debugInfo.localStorage[key] = localStorage.getItem(key);
                        } catch (e) {
                            debugInfo.localStorage[key] = `[Error reading value: ${e.message}]`;
                        }
                    }
                    
                    // 创建下载链接
                    const dataStr = JSON.stringify(debugInfo, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `task-manager-debug-${new Date().toISOString().slice(0, 10)}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    
                    resultElement.textContent = '✅ 调试信息已导出\n';
                    resultElement.className = 'test-result success';
                } catch (e) {
                    resultElement.textContent = `❌ 导出调试信息失败: ${e.message}\n`;
                    resultElement.className = 'test-result error';
                }
            }
            
            // 初始化页面
            updateOnlineStatus();
            updateSyncTime();
            updateLocalVersion();
            
            // 添加事件监听器
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            document.getElementById('run-diagnostic').addEventListener('click', runDiagnostic);
            document.getElementById('force-sync').addEventListener('click', forceSync);
            document.getElementById('auto-fix').addEventListener('click', autoFix);
            document.getElementById('check-consistency').addEventListener('click', checkConsistency);
            document.getElementById('repair-data').addEventListener('click', repairData);
            document.getElementById('clear-local-data').addEventListener('click', clearLocalData);
            document.getElementById('reset-sync').addEventListener('click', resetSync);
            document.getElementById('export-debug').addEventListener('click', exportDebug);
        });
    </script>
</body>
</html>
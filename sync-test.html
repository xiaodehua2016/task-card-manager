<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åŒæ­¥æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            border-left: 4px solid #007bff;
        }
        .status-card.success { border-left-color: #28a745; }
        .status-card.warning { border-left-color: #ffc107; }
        .status-card.error { border-left-color: #dc3545; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.danger { background: #dc3545; }
        .log-area {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 16px 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 20px 0;
        }
        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
        }
        .info-label {
            font-weight: bold;
            color: #495057;
            font-size: 12px;
            text-transform: uppercase;
        }
        .info-value {
            font-size: 14px;
            margin-top: 4px;
        }
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 12px;
        }
        .back-link:hover {
            background: #5a6268;
            color: white;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">â† è¿”å›ä¸»é¡µ</a>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ æ•°æ®åŒæ­¥æµ‹è¯•å·¥å…·</h1>
            <p>ç”¨äºè¯Šæ–­å’Œä¿®å¤è·¨æµè§ˆå™¨æ•°æ®åŒæ­¥é—®é¢˜</p>
        </div>

        <div class="status-card" id="sync-status">
            <h3>ğŸ” åŒæ­¥çŠ¶æ€æ£€æŸ¥</h3>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è¯Šæ–­...</p>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" onclick="runDiagnostic()">ğŸ” è¿è¡Œè¯Šæ–­</button>
            <button class="btn success" onclick="forceSync()">ğŸ”„ å¼ºåˆ¶åŒæ­¥</button>
            <button class="btn warning" onclick="cleanupStorage()">ğŸ§¹ æ¸…ç†å­˜å‚¨</button>
            <button class="btn danger" onclick="resetAllData()">âš ï¸ é‡ç½®æ•°æ®</button>
        </div>

        <div class="info-grid" id="info-grid">
            <!-- ä¿¡æ¯å°†é€šè¿‡JavaScriptå¡«å…… -->
        </div>

        <div class="log-area" id="log-area">
            <div>ç­‰å¾…æ“ä½œ...</div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <button class="btn" onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/cross-browser-sync.js"></script>
    <script src="js/sync-diagnostic.js"></script>

    <script>
        // æ—¥å¿—ç®¡ç†
        const logArea = document.getElementById('log-area');
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '4px';
            
            const typeIcon = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ'
            }[type] || 'â„¹ï¸';
            
            logEntry.innerHTML = `<span style="color: #6c757d;">[${timestamp}]</span> ${typeIcon} ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // é‡å†™consoleæ–¹æ³•ä»¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addLog(args.join(' '), 'info');
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addLog(args.join(' '), 'warning');
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        // æµ‹è¯•åŠŸèƒ½
        async function runDiagnostic() {
            addLog('å¼€å§‹è¿è¡Œè¯Šæ–­...', 'info');
            
            if (window.syncDiagnostic) {
                try {
                    const results = await window.syncDiagnostic.runFullDiagnostic();
                    updateStatusCard(results);
                    updateInfoGrid(results);
                    addLog('è¯Šæ–­å®Œæˆ', 'success');
                } catch (error) {
                    addLog('è¯Šæ–­å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                addLog('è¯Šæ–­å·¥å…·æœªåŠ è½½', 'error');
            }
        }

        async function forceSync() {
            addLog('å¼€å§‹å¼ºåˆ¶åŒæ­¥...', 'info');
            
            if (window.dataSyncManager && window.dataSyncManager.forceSync) {
                try {
                    const success = await window.dataSyncManager.forceSync();
                    if (success) {
                        addLog('å¼ºåˆ¶åŒæ­¥æˆåŠŸ', 'success');
                        setTimeout(runDiagnostic, 1000); // 1ç§’åé‡æ–°è¯Šæ–­
                    } else {
                        addLog('å¼ºåˆ¶åŒæ­¥å¤±è´¥', 'error');
                    }
                } catch (error) {
                    addLog('å¼ºåˆ¶åŒæ­¥å‡ºé”™: ' + error.message, 'error');
                }
            } else {
                addLog('åŒæ­¥ç®¡ç†å™¨æœªåŠ è½½', 'error');
            }
        }

        function cleanupStorage() {
            addLog('å¼€å§‹æ¸…ç†å­˜å‚¨...', 'info');
            
            if (window.syncDiagnostic) {
                try {
                    window.syncDiagnostic.cleanupDuplicateStorage();
                    addLog('å­˜å‚¨æ¸…ç†å®Œæˆ', 'success');
                    setTimeout(runDiagnostic, 500);
                } catch (error) {
                    addLog('å­˜å‚¨æ¸…ç†å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                addLog('è¯Šæ–­å·¥å…·æœªåŠ è½½', 'error');
            }
        }

        function resetAllData() {
            if (confirm('âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼')) {
                addLog('å¼€å§‹é‡ç½®æ•°æ®...', 'warning');
                
                try {
                    const keys = ['taskManagerData', 'xiaojiu_tasks', 'tasks'];
                    keys.forEach(key => {
                        localStorage.removeItem(key);
                        addLog(`å·²åˆ é™¤å­˜å‚¨é”®: ${key}`, 'info');
                    });
                    
                    addLog('æ•°æ®é‡ç½®å®Œæˆ', 'success');
                    setTimeout(runDiagnostic, 500);
                } catch (error) {
                    addLog('æ•°æ®é‡ç½®å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        function clearLog() {
            logArea.innerHTML = '<div>æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        function exportLog() {
            const logText = Array.from(logArea.children)
                .map(child => child.textContent)
                .join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sync-log-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        function updateStatusCard(results) {
            const statusCard = document.getElementById('sync-status');
            const level = results.syncStatus.level;
            const message = results.syncStatus.message;
            
            statusCard.className = `status-card ${level}`;
            statusCard.innerHTML = `
                <h3>ğŸ” åŒæ­¥çŠ¶æ€æ£€æŸ¥</h3>
                <p><strong>çŠ¶æ€:</strong> ${message}</p>
                <p><strong>æ£€æŸ¥æ—¶é—´:</strong> ${new Date(results.timestamp).toLocaleString()}</p>
            `;
        }

        function updateInfoGrid(results) {
            const infoGrid = document.getElementById('info-grid');
            
            infoGrid.innerHTML = `
                <div class="info-item">
                    <div class="info-label">æœ¬åœ°æ•°æ®</div>
                    <div class="info-value">${results.localData.available ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}</div>
                    <div class="info-value">å­˜å‚¨é”®: ${results.localData.keys.length}</div>
                    <div class="info-value">å¤§å°: ${Math.round(results.localData.dataSize / 1024)}KB</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æœåŠ¡å™¨æ•°æ®</div>
                    <div class="info-value">${results.serverData.accessible ? 'âœ… å¯è®¿é—®' : 'âŒ ä¸å¯è®¿é—®'}</div>
                    <div class="info-value">${results.serverData.available ? 'âœ… æœ‰æ•°æ®' : 'âŒ æ— æ•°æ®'}</div>
                    ${results.serverData.error ? `<div class="info-value" style="color: #dc3545;">é”™è¯¯: ${results.serverData.error}</div>` : ''}
                </div>
                <div class="info-item">
                    <div class="info-label">æ—¶é—´å·®</div>
                    <div class="info-value">${Math.round(results.syncStatus.timeDiff / 1000)}ç§’</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ä¿®å¤å»ºè®®</div>
                    <div class="info-value">${results.recommendations.length}ä¸ªå»ºè®®</div>
                </div>
            `;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', () => {
            addLog('é¡µé¢åŠ è½½å®Œæˆ', 'success');
            setTimeout(runDiagnostic, 1000);
        });
    </script>
</body>
</html>